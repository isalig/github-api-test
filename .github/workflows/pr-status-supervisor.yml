name: Check CI Statuses for Renovate PRs

on:
  status:

jobs:
  check-renovate-statuses:
    runs-on: ubuntu-latest

    steps:
      - name: –ù–∞–π—Ç–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–π Pull Request
        id: find_pr
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`
            });

            if (prs.data.length === 0) {
              core.setFailed("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω PR, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —ç—Ç–∏–º –∫–æ–º–º–∏—Ç–æ–º.");
              return;
            }

            const pr = prs[0];
            core.setOutput("pr_number", pr.number);
            core.setOutput("labels", pr.labels.map(label => label.name).join(','));

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –ª–µ–π–±–ª "renovate"
        run: |
          echo "–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ª–µ–π–±–ª—ã: ${{ steps.find_pr.outputs.labels }}"
          if [[ "${{ steps.find_pr.outputs.labels }}" != *"renovate"* ]]; then
            echo "‚ö†Ô∏è –õ–µ–π–±–ª 'renovate' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ."
            exit 0
          fi

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –∏–∑ secrets
        uses: actions/github-script@v7
        with:
          script: |
            const expected = [process.env.STATUS_NAME_1, process.env.STATUS_NAME_2];

            const { data: status } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });

            const found = {};
            for (const s of status.statuses) {
              found[s.context] = s.state;
            }

            let failed = false;
            for (const name of expected) {
              const state = found[name];
              console.log(`üîç –°—Ç–∞—Ç—É—Å "${name}": ${state}`);
              if (state !== "success") {
                failed = true;
              }
            }

            if (failed) {
              core.setFailed("‚ùå –û–¥–∏–Ω –∏–ª–∏ –æ–±–∞ —Ç—Ä–µ–±—É–µ–º—ã—Ö —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ —É—Å–ø–µ—à–Ω—ã.");
            } else {
              console.log("‚úÖ –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã —É—Å–ø–µ—à–Ω—ã.");
            }

      - name: –£—Å–ø–µ—à–Ω–æ ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
        if: ${{ success() }}
        run: echo "üéâ –í—Å–µ CI –ø—Ä–æ—à–ª–∏ –∏ PR –æ—Ç Renovate ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å."
